/*
 * Deadlock API
 *
 *  ## API Clients  We have auto generated and updated clients for many languages. You can find them here: [https://github.com/deadlock-api/openapi-clients](https://github.com/deadlock-api/openapi-clients)  ## Support the Deadlock API  Whether you're building your own database, developing data science projects, or enhancing your website with game and player analytics, the Deadlock API has the data you need.  Your sponsorship helps keep this resource open, free and future-proof for everyone. By supporting the Deadlock API, you will enable continued development, new features and reliable access for developers, analysts and streamers worldwide.  Help us continue to provide the data you need - sponsor the Deadlock API today!  **-> You can Sponsor the Deadlock API on [Patreon](https://www.patreon.com/c/user?u=68961896) or [GitHub](https://github.com/sponsors/raimannma)**  ## Disclaimer _deadlock-api.com is not endorsed by Valve and does not reflect the views or opinions of Valve or anyone officially involved in producing or managing Valve properties. Valve and all associated properties are trademarks or registered trademarks of Valve Corporation_         
 *
 * The version of the OpenAPI document: 0.1.0
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using DeadlockApiClient.Api;
using DeadlockApiClient.Model;

namespace DeadlockApiClient.Client
{
    /// <summary>
    /// Provides hosting configuration for DeadlockApiClient
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();

        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// Instantiates the class 
        /// </summary>
        /// <param name="services"></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new APIInfoJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchGameModeJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchGameModeNullableJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchModeJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchModeNullableJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchPlayerJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchTeamJsonConverter());
            _jsonOptions.Converters.Add(new ActiveMatchTeamNullableJsonConverter());
            _jsonOptions.Converters.Add(new AnalyticsAbilityOrderStatsJsonConverter());
            _jsonOptions.Converters.Add(new AnalyticsHeroStatsJsonConverter());
            _jsonOptions.Converters.Add(new BadgeDistributionJsonConverter());
            _jsonOptions.Converters.Add(new BuildJsonConverter());
            _jsonOptions.Converters.Add(new BuildHeroJsonConverter());
            _jsonOptions.Converters.Add(new BuildHeroDetailsJsonConverter());
            _jsonOptions.Converters.Add(new BuildHeroDetailsAbilityOrderJsonConverter());
            _jsonOptions.Converters.Add(new BuildHeroDetailsAbilityOrderCurrencyChangeJsonConverter());
            _jsonOptions.Converters.Add(new BuildHeroDetailsCategoryJsonConverter());
            _jsonOptions.Converters.Add(new BuildHeroDetailsCategoryAbilityJsonConverter());
            _jsonOptions.Converters.Add(new BuildItemStatsJsonConverter());
            _jsonOptions.Converters.Add(new ClickhouseMatchInfoJsonConverter());
            _jsonOptions.Converters.Add(new ClickhouseSaltsJsonConverter());
            _jsonOptions.Converters.Add(new CreateCustomRequestJsonConverter());
            _jsonOptions.Converters.Add(new CreateCustomResponseJsonConverter());
            _jsonOptions.Converters.Add(new DistributionEntryJsonConverter());
            _jsonOptions.Converters.Add(new EnemyStatsJsonConverter());
            _jsonOptions.Converters.Add(new EntryJsonConverter());
            _jsonOptions.Converters.Add(new GameModeJsonConverter());
            _jsonOptions.Converters.Add(new GameModeNullableJsonConverter());
            _jsonOptions.Converters.Add(new GetCustomMatchIdResponseJsonConverter());
            _jsonOptions.Converters.Add(new HashMapValueJsonConverter());
            _jsonOptions.Converters.Add(new HeroCombStatsJsonConverter());
            _jsonOptions.Converters.Add(new HeroCounterStatsJsonConverter());
            _jsonOptions.Converters.Add(new HeroStatsJsonConverter());
            _jsonOptions.Converters.Add(new HeroSynergyStatsJsonConverter());
            _jsonOptions.Converters.Add(new ItemPermutationStatsJsonConverter());
            _jsonOptions.Converters.Add(new ItemStatsJsonConverter());
            _jsonOptions.Converters.Add(new KillDeathStatsJsonConverter());
            _jsonOptions.Converters.Add(new LeaderboardJsonConverter());
            _jsonOptions.Converters.Add(new LeaderboardEntryJsonConverter());
            _jsonOptions.Converters.Add(new MMRHistoryJsonConverter());
            _jsonOptions.Converters.Add(new MatchSaltsResponseJsonConverter());
            _jsonOptions.Converters.Add(new MatchSpectateResponseJsonConverter());
            _jsonOptions.Converters.Add(new MateStatsJsonConverter());
            _jsonOptions.Converters.Add(new PartyStatsJsonConverter());
            _jsonOptions.Converters.Add(new PatchJsonConverter());
            _jsonOptions.Converters.Add(new PatchCategoryJsonConverter());
            _jsonOptions.Converters.Add(new PatchGuidJsonConverter());
            _jsonOptions.Converters.Add(new PlayerAccountHeroStatsJsonConverter());
            _jsonOptions.Converters.Add(new PlayerAccountStatsJsonConverter());
            _jsonOptions.Converters.Add(new PlayerCardJsonConverter());
            _jsonOptions.Converters.Add(new PlayerCardSlotJsonConverter());
            _jsonOptions.Converters.Add(new PlayerCardSlotHeroJsonConverter());
            _jsonOptions.Converters.Add(new PlayerCardSlotStatJsonConverter());
            _jsonOptions.Converters.Add(new PlayerMatchHistoryEntryJsonConverter());
            _jsonOptions.Converters.Add(new PlayerPerformanceCurvePointJsonConverter());
            _jsonOptions.Converters.Add(new RegionModeJsonConverter());
            _jsonOptions.Converters.Add(new RegionModeNullableJsonConverter());
            _jsonOptions.Converters.Add(new ServerRegionJsonConverter());
            _jsonOptions.Converters.Add(new ServerRegionNullableJsonConverter());
            _jsonOptions.Converters.Add(new StatusJsonConverter());
            _jsonOptions.Converters.Add(new StatusServicesJsonConverter());
            _jsonOptions.Converters.Add(new SteamProfileJsonConverter());
            _jsonOptions.Converters.Add(new TableSizeJsonConverter());
            _jsonOptions.Converters.Add(new VariableCategoryJsonConverter());
            _jsonOptions.Converters.Add(new VariableCategoryNullableJsonConverter());
            _jsonOptions.Converters.Add(new VariableDescriptionJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<AnalyticsApiEvents>();
            _services.AddSingleton<BuildsApiEvents>();
            _services.AddSingleton<CommandsApiEvents>();
            _services.AddSingleton<CustomMatchesApiEvents>();
            _services.AddSingleton<InfoApiEvents>();
            _services.AddSingleton<InternalApiEvents>();
            _services.AddSingleton<LeaderboardApiEvents>();
            _services.AddSingleton<MMRApiEvents>();
            _services.AddSingleton<MatchesApiEvents>();
            _services.AddSingleton<PatchesApiEvents>();
            _services.AddSingleton<PlayersApiEvents>();
            _services.AddSingleton<SQLApiEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="client"></param>
        /// <param name="builder"></param>
        /// <returns></returns>
        public HostConfiguration AddApiHttpClients
        (
            Action<HttpClient>? client = null, Action<IHttpClientBuilder>? builder = null)
        {
            if (client == null)
                client = c => c.BaseAddress = new Uri(ClientUtils.BASE_ADDRESS);

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IAnalyticsApi, AnalyticsApi>("DeadlockApiClient.Api.IAnalyticsApi", client));
            builders.Add(_services.AddHttpClient<IBuildsApi, BuildsApi>("DeadlockApiClient.Api.IBuildsApi", client));
            builders.Add(_services.AddHttpClient<ICommandsApi, CommandsApi>("DeadlockApiClient.Api.ICommandsApi", client));
            builders.Add(_services.AddHttpClient<ICustomMatchesApi, CustomMatchesApi>("DeadlockApiClient.Api.ICustomMatchesApi", client));
            builders.Add(_services.AddHttpClient<IInfoApi, InfoApi>("DeadlockApiClient.Api.IInfoApi", client));
            builders.Add(_services.AddHttpClient<IInternalApi, InternalApi>("DeadlockApiClient.Api.IInternalApi", client));
            builders.Add(_services.AddHttpClient<ILeaderboardApi, LeaderboardApi>("DeadlockApiClient.Api.ILeaderboardApi", client));
            builders.Add(_services.AddHttpClient<IMMRApi, MMRApi>("DeadlockApiClient.Api.IMMRApi", client));
            builders.Add(_services.AddHttpClient<IMatchesApi, MatchesApi>("DeadlockApiClient.Api.IMatchesApi", client));
            builders.Add(_services.AddHttpClient<IPatchesApi, PatchesApi>("DeadlockApiClient.Api.IPatchesApi", client));
            builders.Add(_services.AddHttpClient<IPlayersApi, PlayersApi>("DeadlockApiClient.Api.IPlayersApi", client));
            builders.Add(_services.AddHttpClient<ISQLApi, SQLApi>("DeadlockApiClient.Api.ISQLApi", client));
            
            if (builder != null)
                foreach (IHttpClientBuilder instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the JsonSerializerSettings
        /// </summary>
        /// <param name="options"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="token"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            return AddTokens(new TTokenBase[]{ token });
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="tokens"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            TokenContainer<TTokenBase> container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(services => container);

            return this;
        }

        /// <summary>
        /// Adds a token provider to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenProvider"></typeparam>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <returns></returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>() 
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }
    }
}
